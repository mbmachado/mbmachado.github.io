<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>Escalonador de Processos</title>
	<link rel="stylesheet" href="assets/vendor/materialize/css/material-icons.css">
	<link rel="stylesheet" href="assets/vendor/jQuery-ui-1.12.1/jquery-ui.min.css">
	<link rel="stylesheet" href="assets/vendor/materialize/css/materialize.min.css">
	<link rel="stylesheet" href="assets/css/stylesheet.css">
	<link rel="icon" href="assets/img/favicon.png">
	<link rel="manifest" href="manifest.json">
</head>
<body class="blue-grey lighten-5">
	<div class="row my-no-m-b">
		<div class="col s12 m3 l3 teal lighten-2 my-scrollabel">
			<div class="row my-no-m-b">
				<div class="col s12">
					<h5 class="center-align blue-grey-text text-lighten-5 my-no-m-b">Escalonador de Processos</h5>
					<p class="center-align blue-grey-text text-lighten-5 my-no-m-t my-m-b-10">By Enrique W., Mateus B. e Mateus C.</p>
				</div>
			</div>
			<div class="row">
				<div class="col s12">
					<div class="card-panel my-main-card">
						<div id="progress_bar" class="progress my-progress-bar indigo lighten-4">
						    <div class="indeterminate indigo darken-2"></div>
						</div>
						<div id="overlay_panel" class="my-overlay">
							<div id="inner_overlay_panel" class="my-inner-overlay">
								<div class="row">
									<div class="col s12 center-align">
										<span>Turnaround Médio</span>
									</div>
								</div>
								<div class="row">
									<div class="col s12 center-align">
										<span id="mean_turnaround"></span>
									</div>
								</div>
								<div class="row">
									<div class="col s12 center-align">
										<a id="replay_btn" class="waves-effect waves-light btn cyan lighten-2 pulse">De novo</a>
									</div>
								</div>
							</div>
						</div>
						<form id="main_form" action="#" method="POST">
							<div class="row my-no-m-b">
								<div class="input-field col s12">
						        	<input id="process_number" type="text" class="numbers" autocomplete="off">
						        	<label class="truncate" for="process_number">Número de Processos</label>
						        </div>
							</div>
							<div class="row my-no-m-b">
								<div class="input-field col s6">
						        	<input id="quamtum_number" type="text" class="1-to-9" autocomplete="off">
						        	<label for="quamtum_number">Quamtum</label>
						        </div>
						        <div class="input-field col s6">
						        	<input id="overload_number" type="text" class="1-to-9" autocomplete="off">
						        	<label for="overload_number">Sobrecarga</label>
						        </div>
							</div>
							<div class="row my-no-m-b">
								<div class="input-field col s12">
									<select id="page_replacement">
										<option value="FIFO" selected>FIFO</option>
										<option value="LRU">Menos recentemente utilizado</option>
									</select>
									<label>Substituição de Páginas</label>
								</div>
							</div>
							<div class="row my-no-m-b">
								<div class="col s12">
									<label>Algoritmo de escalonamento</label>
									<p>
										<label>
											<input class="with-gap" name="algorithm" value="FIFO" type="radio" checked/>
											<span>FIFO</span>
										</label>
									</p>
									<p>
										<label>
											<input class="with-gap" name="algorithm" value="SJF" type="radio"/>
											<span>SJF</span>
										</label>
									</p>
									<p>
										<label>
											<input class="with-gap" name="algorithm" value="RR" type="radio"/>
											<span>Round Robin</span>
										</label>
									</p>
									<p>
										<label>
											<input class="with-gap" name="algorithm" value="EDF" type="radio"/>
											<span>EDF</span>
										</label>
									</p>
								</div>
							</div>
							<div class="row my-no-m-b">
								<div class="col s6 m4">
									<button class="btn waves-effect waves-light" type="submit" name="action">Iniciar</button>
								</div>
								<div class="col s6 m4">
									<button id="reset_btn" class="btn waves-effect waves-red blue-grey lighten-4 blue-grey-text text-darken-4" type="reset">Limpar</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
		<div class="col s12 m9 l9 blue-grey lighten-5 my-scrollabel">
			<div id="processes_info_box" class="row"></div>
			<div id="graphs_box" class="row">
				<div class="col s12">
					<div class="card-panel">
						<div class="row">
							<div class="col s12">
								<h6>Gráfico de Gantt</h6>
							</div>
						</div>
						<div id="gantt_graph" class="my-gantt-graph"></div>
						<div class="row">
							<div class="col s6 m2 valign-wrapper my-s-m-b-5">
								<div class="my-subtitle-square teal lighten-2"></div>
								<label>Executando</label>
							</div>
							<div class="col s6 m2 valign-wrapper my-s-m-b-5">
								<div class="my-subtitle-square red lighten-2"></div>
								<label>Sobrecarga</label>
							</div>
							<div class="col s6 m2 valign-wrapper my-s-m-b-5">
								<div class="my-subtitle-square blue-grey lighten-2"></div>
								<label>Estouro DL</label>
							</div>
							<div class="col s6 m2 valign-wrapper my-s-m-b-5">
								<div class="my-subtitle-line indigo darken-2"></div>
								<label>DeadLine</label>
							</div>
							<div class="col s12 m4">
								<div class="switch right-align my-switch">
								    <label>
								    	Rolagem automática
								    	<input type="checkbox" checked>
								    	<span class="lever my-lever"></span>
								    </label>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col s12">
					<div class="row">
						<div class="col s12 m6">
							<div class="card-panel">
								<div class="row">
									<div  class="col s12">
										<h6>Memória RAM</h6>
									</div>
								</div>
								<div id="mem_graph" class="my-mem-graph"></div>
							</div>
						</div>
						<div class="col s12 m6">
							<div class="card-panel">
								<div class="row">
									<div class="col s12">
										<h6>Disco</h6>
									</div>
								</div>
								<div id="hd_graph" class="my-hd-graph"></div>
							</div>
						</div>
						
					</div>
				</div>
			</div>
		</div>
    </div>
    <div id="draggable_pages_table" class="draggable resizable ui-widget-content">
		<div class="card">
			<div class="card-content">
				<div class="row">
					<div class="col s6 my-no-p">
						<h6>Tabela de Páginas</h6>
					</div>
					<div class="col s6 my-no-p">
						<a id="hide_btn" class="waves-effect waves-red btn-flat right"><i class="material-icons">close</i></a>
					</div>
				</div>
				<div id="pages_graph" class="my-pages-graph"></div>
			</div>
		</div>
	</div>
    <div id="toggle_container" class="fixed-action-btn">
    	<a id="toggle_btn" href="#" class="btn-floating btn-large waves-effect waves-light"><i class="material-icons">library_books</i></a>
    </div>
    <div id="error_modal" class="modal">
	    <div class="modal-content">
	      <h4>Erro</h4>
	      <p id="modal_content"></p>
	    </div>
	    <div class="modal-footer">
	      <a href="#!" class="modal-close waves-effect waves-teal btn-flat">Ok</a>
	    </div>
  	</div>
	<script src="assets/vendor/jQuery/jquery-3.3.1.min.js"></script>
	<script src="assets/vendor/jQuery-ui-1.12.1/jquery-ui.min.js"></script>
	<script src="assets/vendor/jQuery-Mask-Plugin/dist/jquery.mask.min.js"></script>
	<script src="assets/vendor/velocity/velocity.min.js"></script>
	<script src="assets/vendor/materialize/js/materialize.min.js"></script>
	<script src="assets/js/script.js"></script>
	<script>
		"use strict";

		function pageChangesFIFO(actualTime){
			var maxPagChange=3;
			var procOut=-1, proIn=-1;
			var pos=-1;
			var choiceCol=-1, minCol=extremeDeadline;
			var flagEnd=0;
			if(waitListForIO>0){
				procIn=waitListForIO[0];
				for(let i=0; i<5; i++){
					if(pageMemoryTime[i]._proc != -1 && pageMemoryTime[i]._time < minCol){
						minCol=pageMemoryTime[i]._time;
						procOut=pageMemoryTime[i]._proc;
						pos=i;
					}
				}
				sortData[procOut]._makingIO=1;
				var ini = sortData[porcOut]._memoria*10+1;
				for(let i=0; i<maxPagChange; i++){
					if(posRam[pos]._qtdPaginas > 0){
						removeProcessFromRAM(ini+(10-posRam[pos]._qtdPaginas));
						setProcessInRAM(procIn,ini+(10-posRam[pos]._qtdPaginas));
						posRam[pos]._qtdPaginas--;
					}else{
						flagEnd=1;
					}
				}
				if(flagEnd == 1){
					sortData[procOut]._memoria=-1;
					sortData[procOut]._makingIO=0;
					sortData[procIn]._memoria=pos;
					sortData[procIn]._makingIO=0;
					posRam[pos]._qtdPaginas=10;
					posRam[pos]._proc=procIn;
					pageMemoryTime[pos]._proc=procIn;
					pageMemoryTime[pos]._time=actualTime;
					waitListForIO.shift();
				}
			}
		}

		function processWaitChange(processIn){
			waitListForIO.push(processIn);
		}

		function pushElementNowInRAM(proc, pos, actualTime){
			pageMemoryTime[pos]._time = actualTime;
			pageMemoryTime[pos]._proc = proc;
		}

		function choiceProcessEDF(actualTime) {
			var minDeadline = extremeDeadline;
			var marcado=0;
			for(let j=0; j<sortData.length; j++){
				if(sortData[j]._start <= actualTime && sortData[j]._timeLeft > 0 && sortData[j]._deadline < minDeadline && sortData[j]._makingIO==0){

					if(sortData[j]._memoria==-1 && freeMemory>0){
						minDeadline = sortData[j]._deadline;
						currentProcess = j;
						marcado=1;
					}else if(sortData[j]._memoria==-1){
						sortData[j]._makingIO=1;
						processWaitChange(i);
					}else{
						minDeadline = sortData[j]._deadline;
						currentProcess = j;
						marcado=1;
					}
				}	
			}
			if(sortData[j]._memoria==-1 && freeMemory>0){
				putMemoryWIthFreeSpace(currentProcess, actualTime);
			}
		}

		function remJustHD(proc){
			var ini=sortData[proc]._hd*10+1;
			posHd[sortData[proc]._hd]._proc=-1;
			sortData[proc]._hd=-1;
			freeHd++;
			for(let i=0; i<10; i++){
				removeProcessFromHD(ini+i);
			} 
			
		}	

		function remJustRAM(proc){
			var ini=sortData[proc]._memoria*10+1;
			posRam[sortData[proc]._memoria]._proc=-1;
			posRam[sortData[proc]._memoria]._qtdPaginas=10;
			sortData[proc]._memoria=-1;
			freeMemory++;
			for(let i=0; i<10; i++){
				removeProcessFromRAM(ini+i);
			}
		}		

		function putJustInRAM(proc, actualTime){
			takeNextFreeSpaceInMemory();
			var ini=nextFreePositionR*10+1;
			sortData[proc]._memoria=nextFreePositionR;
			posRam[nextFreePositionR]._proc = sortData[proc]._processNumber;
			freeMemory--;
			for(let i=0; i<10; i++){
				setProcessInRAM(ini+i, sortData[proc]._processNumber);
			}
			pushElementNowInRAM(proc,  nextFreePositionR, actualTime);
		}

		function putJustInHD(proc){
			takeNextFreeSpaceInMemory();
			var ini=nextFreePositionH*10+1;
			sortData[proc]._hd=nextFreePositionH;
			posHd[nextFreePositionH]._proc = sortData[proc]._processNumber;
			freeHd--;
			for(let i=0; i<10; i++){
				setProcessInHD(ini+i, sortData[proc]._processNumber);
			}
		}

		function takeNextFreeSpaceInMemory(){
			nextFreePositionH=-1;
			nextFreePositionR=-1;
			var flagM=0;
			for(let i=0; i<posHd.length; i++){
				if(flagM==0 && posHd[i]._proc == -1){
					nextFreePositionH=i;
					flagM=1;
				} 
			}
			flagM=0;
			for(let i=0; i<posRam.length; i++){
				if(flagM==0 && posRam[i]._proc == -1){
					nextFreePositionR=i;
					flagM=1;
				} 
			}
			
		}
		
		function putMemoryWIthFreeSpace(proc, actualTime){
			takeNextFreeSpaceInMemory();
			if(sortData[proc]._hd==-1){
				sortData[proc]._hd=nextFreePositionH;
				var ini = nextFreePositionH*10+1;
				freeHd--;
				posHd[nextFreePositionH]._proc = sortData[proc]._processNumber;
				for(let i=0; i<10; i++){
					setProcessInHD(ini+i, sortData[proc]._processNumber);
				}
			}
			ini=nextFreePositionR*10+1;
			sortData[proc]._memoria=nextFreePositionR;
			posRam[nextFreePositionR]._proc = sortData[proc]._processNumber;
			freeMemory--;
			for(let i=0; i<10; i++){
				setProcessInRAM(ini+i, sortData[proc]._processNumber);
			}
			pushElementNowInRAM(proc,  nextFreePositionR, actualTime);
		}

		function choiceProcessFIFO(actualTime){
			var marcado=0;
			currentProcess=-1;
			for(let i=0; i<sortData.length; i++){
				if(sortData[i]._start <= actualTime && marcado==0 && sortData[i]._makingIO==0 && sortData[i]._timeLeft>0){
					if(sortData[i]._memoria==-1 && freeMemory>0){
						putMemoryWIthFreeSpace(i, actualTime);
						marcado=1;
						currentProcess=i;
					}else if(sortData[i]._memoria==-1){
						sortData[i]._makingIO=1;
						processWaitChange(i);
					}else{
						marcado=1;
						currentProcess=i;
					}
				}
			}
		}

		function choiceProcessSJF(actualTime){
			var marcado=0;
			currentProcess=-1;
			var procAux=extremeDeadline;
			for(let i=0; i<sortData.length; i++){
				if(sortData[i]._start <= actualTime && sortData[i]._makingIO==0 && sortData[i]._timeLeft>0 && sortData[i]._time < procAux){
					if(sortData[i]._memoria==-1 && freeMemory>0){
						putMemoryWIthFreeSpace(i, actualTime);
						currentProcess=i
						procAux = sortData[i]._time;
					}else if(sortData[i]._memoria==-1){
						sortData[i]._makingIO=1;
						processWaitChange(i);
					}else{
						currentProcess=i
						procAux = sortData[i]._time;
					}
				}
			}	
		}

		function putOtherProcess(actualTime){
			for(let i=0; i<sortData.length; i++){
				if(sortData[i]._start <= actualTime && sortData[i]._hd==-1 && sortData[i]._timeLeft > 0){
					putJustInHD(i);
					if(freeMemory > 0){
						putJustInRAM(i, actualTime);
					}
				}
			}
		}

		function fifo2() {
			var lastPosition = 0;
			var i = 0;
			var tam = sortData.length;
			while(i < tam){
				currentProcess = -1;
				choiceProcessFIFO(lastPosition);
				while(currentProcess == -1){
					lastPosition++;
					//paginas
					choiceProcessFIFO(lastPosition);
				}
				for(let j=0; j<sortData[i]._time; j++) {
					makeProgressInGanttSquare(sortData[currentProcess]._processNumber, lastPosition);
					lastPosition++;
					putOtherProcess(lastPosition);
					//paginas
				}
				sortData[currentProcess]._endTime=lastPosition;
				sortData[currentProcess]._timeLeft=0;
				remJustRAM(currentProcess);
				remJustHD(currentProcess);
				i++;
			}
		}

		function fifo() {
			var lastPosition = 0;
			for(let i= 0; i < sortData.length; i++) {
				if(lastPosition < sortData[i]._start) {
					lastPosition = sortData[i]._start;
				}
				for(let j=0; j<sortData[i]._time; j++) {
					makeProgressInGanttSquare(sortData[i]._processNumber, lastPosition);
					lastPosition++;
				}
				sortData[i]._endTime = lastPosition;
			}
		}
        
        function sjf() {
			var lastPosition = 0;
			var lastPosition = 0;
			var i = 0;
			var tam = sortData.length;
			while(i < tam){
				currentProcess = -1;
				choiceProcessSJF(lastPosition);
				while(currentProcess == -1){
					lastPosition++;
					//paginas
					choiceProcessSJF(lastPosition);
				}
				for(let j=0; j<sortData[i]._time; j++) {
					makeProgressInGanttSquare(sortData[currentProcess]._processNumber, lastPosition);
					lastPosition++;
					putOtherProcess(lastPosition);
					//paginas
				}
				sortData[currentProcess]._endTime=lastPosition;
				sortData[currentProcess]._timeLeft=0;
				remJustRAM(currentProcess);
				remJustHD(currentProcess);
				i++;
			}            
		}
        
        function roundRobin() {
            var lastPosition = 0;
            var spinning = [];
            var count = 0;
            var countLastPos = 0;
            var currentProcess;
            var timeForExecution;
            var nextIsOver;
            var rrIsOver = false;
            var spinningIsOver = false;
            
            while(!rrIsOver){
                
                if(lastPosition < sortData[count]._start) {
					lastPosition = sortData[count]._start;
				}
                for (;count < sortData.length; count++) {
                    if (sortData[count]._start <= lastPosition) {
                        spinning.push(count);
                    }else{
                        break;
                    }
                }
                    
                spinningIsOver = false;
                while (!spinningIsOver){
                    if (spinning.length <= 0){ break; }
                    currentProcess = spinning.shift();
                    if(sortData[currentProcess]._timeLeft <= data["quantum"]) {
                        timeForExecution = sortData[currentProcess]._timeLeft;
                        nextIsOver = true;
                    }else{
                        timeForExecution = data["quantum"];
                        nextIsOver = false;
                    }
                    sortData[currentProcess]._timeLeft -= timeForExecution;

                    for(let j = 0; j < timeForExecution; j++) {
                        makeProgressInGanttSquare(sortData[currentProcess]._processNumber, lastPosition);
                        lastPosition++;
                    }
                    if(nextIsOver) {
                        sortData[currentProcess]._endTime = lastPosition;
                        for (;count < sortData.length; count++) {
                            if (sortData[count]._start <= lastPosition) {
                                spinning.push(count);
                            }else{
                                break;
                            }
                        }
                        if (spinning.length <= 0){
                            spinningIsOver = true;
                        }
                    }else {
                        for(let j = 0; j < data["overload"]; j++) {
                            makeProgressInGanttSquare(sortData[currentProcess]._processNumber, lastPosition, red);
                            lastPosition++;
                        }
                        for (; count < sortData.length; count++) {
                            if (sortData[count]._start <= lastPosition) {
                                spinning.push(count);
                            }else{
                                break;
                            }
                        }
                        spinning.push(currentProcess);
                    }
                }
                
                if (count >= sortData.length) { rrIsOver = true; }
            }
        }

		function edf() {
			var lastPosition = 0;
			var finhishedProcess = 0;
			var allProcess = sortData.length;
			var timeForExecution;
			var timeAfterDeadline;
			var endOneProcess = 0;
			var proc = 0;
			for (var i = 0; i < sortData.length; i++) {
				colorizeBorder(sortData[i]._processNumber, sortData[i]._deadline);
			}

			while(finhishedProcess < allProcess) {
				currentProcess = -1;
				endOneProcess = 0;
				timeForExecution = 0;
				choiceProcessEDF(lastPosition);
				while(currentProcess == -1){
					lastPosition++;
					//paginas
					choiceProcessEDF(lastPosition);
				}
				
				if(sortData[currentProcess]._timeLeft <= data["quantum"]) {
					timeForExecution = sortData[currentProcess]._timeLeft;
					endOneProcess = 1;
				} else {
					timeForExecution = data["quantum"];
				}

				sortData[currentProcess]._timeLeft = sortData[currentProcess]._timeLeft - timeForExecution;
				var colorConsideringDeadline = 0;
				for(let j = 0; j < timeForExecution; j++){
					if(sortData[currentProcess]._deadline <= lastPosition){
						colorConsideringDeadline=2;
					}
					makeProgressInGanttSquare(sortData[currentProcess]._processNumber, lastPosition, colors[colorConsideringDeadline]);
					lastPosition++;
					//paginas
					putOtherProcess(lastPosition);
				}
				if(endOneProcess == 1){
					finhishedProcess++;
					sortData[currentProcess]._endTime = lastPosition;
					remJustHD(currentProcess);
					remJustRAM(currentProcess);
				}else { 
					for(let j = 0; j < data["overload"]; j++) {
						makeProgressInGanttSquare(sortData[currentProcess]._processNumber, lastPosition, red);
						lastPosition++;
						//paginas
						putOtherProcess(lastPosition);
					}
				}
			}
		}

		function main() {
			freeMemory=5;
			freeHd=10;
			switch (data["algorithm"]) {
			    case "FIFO":
			        fifo2(); 
			        break;
			    case "SJF":
			        sjf();
			        break;
			    case "RR":
			        roundRobin();
			        break;
			    case "EDF":
			        edf();
			        break;
			    default:
			    	window.alert("Erro Fatal");
       				break;
			}

			setTimeout(function() { 
				ganttGraph.stop('fx', true, false);
				progressBar.fadeOut('fast');
				meanTurnaroundSpan.html(meanTurnAround()+" s");
				innerOverlayPanel.show('fast');
			}, globalDelay + 600);
		}

	</script>
</body>
</html>